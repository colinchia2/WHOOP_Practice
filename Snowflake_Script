/*******************************************************************************
PROJECT: WHOOP Practice - Sleep, Steps, Calories, and Blood Markers Analysis
PURPOSE: Demonstrate ability to use Snowflake, SQL, and Looker with WHOOP-like data
I will make use of advanced querying, table joins, creating VIEWS, CTEs, and Window Functions 
I have downloaded free FitBit data on sleep, steps, and calories from 30 random users, as well as
a separate blood collection database with 100 patients from Beth Israel Deaconess Medical Center
    FitBit Source: https://www.kaggle.com/datasets/arashnic/fitbit?resource=download-directory
    MIMIC-III Source: https://physionet.org/content/mimiciii-demo/1.4/
AUTHOR: Colin Chiapello
DATE: 02-10-2026
*******************************************************************************/

-- 0. Select Correct Warehouses
-- I have already defined the Warehouse, Database, and following Schemas and 
-- manually uploaded the CSVs and cleaned data of Null rows
USE WAREHOUSE WHOOP_PRACTICE_WH;
-- USE DATABASE WHOOP_HEALTH_DB;
-- USE SCHEMA RAW_HEALTH_DATA;
--      FITBIT_ACTIVITY_RAW
--      FITBIT_SLEEP_RAW
--      MIMIC_LAB_EVENTS_RAW
--      MIMIC_LAB_ITEMS_RAW
-- USE SCHEMA ANALYSIS_VIEWS;
--      FITBIT_USER_SUMMARY
--      FITBIT_FEATURE_USAGE
--      HISTOGRAM_DISTS
--      DAILY_USER_PERFORMANCE (main view used)
--      ACTIVITY_BREAKDOWN
--      SLEEP_BREAKDOWN
--      STEPS_SLEEP_TRADEOFF
--      ACTIVE_SLEEP_TRADEOFF
--      USER_WEEKLY_DASHBOARD
--      MIMIC_CLINICAL_INSIGHTS

-- The following sections show the code I've written to build "Views"
-- These views are then linked to Looker such that they are consisntly live

-- =============================================================================
-- 1. FitBit Steps, Calories, & Sleep Summary by User ID
-- Purpose: Calculate avg baseline metrics for all FitBit users and store in
--      a reference View
-- SQL Logic: Advanced Querying by joining sleep and activity raw data on ID & Date
-- =============================================================================

CREATE OR REPLACE VIEW ANALYSIS_VIEWS.FITBIT_USER_SUMMARY AS
SELECT 
    COALESCE(s.ID, a.ID) AS User_ID,
    
    -- Sleep Avg Metrics
    SUM(s.TOTALMINUTESASLEEP) / 60 AS Total_Sleep_Hours,
    COUNT(s.TOTALMINUTESASLEEP) AS Days_With_Sleep_Data,
    ROUND((SUM(s.TOTALMINUTESASLEEP)/60)/NULLIF(COUNT(s.TOTALMINUTESASLEEP), 0), 2) AS Avg_Hours_Slept,
    
    -- Activity Avg Metrics
    SUM(a.TOTALSTEPS) AS Total_Steps,
    COUNT(a.TOTALSTEPS) AS Days_With_Steps_Data,
    ROUND(SUM(a.TOTALSTEPS) / NULLIF(COUNT(a.TOTALSTEPS), 0), 0) AS Avg_Steps_Per_Active_Day,

    -- Calorie Metrics
    SUM(a.CALORIES) AS Total_Calories_Burned,
    COUNT(a.CALORIES) AS Days_With_Calories_Data,
    ROUND(SUM(a.CALORIES)/NULLIF(COUNT(a.CALORIES), 0), 0) AS Avg_Daily_Calories_Burned,

    -- Activity Metrics
    SUM(a.VERYACTIVEMINUTES) AS Total_Very_Active_Minutes,
    SUM(a.FAIRLYACTIVEMINUTES) AS Total_Fairly_Active_Minutes,
    SUM(a.LIGHTLYACTIVEMINUTES) AS Total_Lightly_Active_Minutes,
    SUM(a.SEDENTARYMINUTES) AS Total_Sedentary_Minutes,
    COUNT(a.VERYACTIVEMINUTES) AS Days_With_Very,
    COUNT(a.FAIRLYACTIVEMINUTES) AS Days_With_Fairly,
    COUNT(a.LIGHTLYACTIVEMINUTES) AS Days_With_Lightly,
    COUNT(a.SEDENTARYMINUTES) AS Days_Sedentary
    
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_SLEEP_RAW s
FULL OUTER JOIN WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW a 
    -- join with THAT NIGHT's sleep
    ON s.ID = a.ID AND s.CORRECT_DATE = DATEADD('day', 1, a.ACTIVITYDATE)
GROUP BY User_ID
ORDER BY User_ID DESC;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.FITBIT_USER_SUMMARY;

-- =================================
-- 1a. FitBit Product Usage 
-- Create a Table to see what the overlap on feature usage is
CREATE OR REPLACE VIEW ANALYSIS_VIEWS.FITBIT_FEATURE_USAGE AS                                    
SELECT
    User_ID,
    Days_With_Sleep_Data,                                                                        
    Days_With_Steps_Data,
    ROUND(Days_With_Steps_Data / NULLIF(MAX(Days_With_Steps_Data) OVER (), 0) * 100, 1) AS PERC_OF_MAX_STEPS,
    ROUND(Days_With_Sleep_Data / NULLIF(Days_With_Steps_Data, 0) * 100, 1) AS PERC_SLEEP_VS_STEPS,
    CASE
        WHEN Days_With_Sleep_Data > 0 AND Days_With_Steps_Data > 0 THEN 'Both'
        WHEN Days_With_Sleep_Data > 0 THEN 'Sleep Only'
        WHEN Days_With_Steps_Data > 0 THEN 'Steps Only'
     END AS TRACKING_TYPE
FROM ANALYSIS_VIEWS.FITBIT_USER_SUMMARY;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.FITBIT_FEATURE_USAGE;


-- =============================================================================
-- 2. FitBit Histogram Distribution on Steps, Calories, & Sleep (Total Population)
-- Purpose: Calculate total population distribution  metrics for all FitBit users 
-- SQL Logic: Use of CTE and statistical functions 
-- =============================================================================

CREATE OR REPLACE VIEW WHOOP_HEALTH_DB.ANALYSIS_VIEWS.HISTOGRAM_DISTS AS                           
WITH step_stats AS (
    SELECT
        AVG(TOTALSTEPS) AS mean_val,
        STDDEV(TOTALSTEPS) AS stddev_val,
        MAX(TOTALSTEPS) AS max_val,
        COUNT(TOTALSTEPS) AS count_n,
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
), cal_stats AS (
    SELECT
        AVG(CALORIES) AS mean_val,
        STDDEV(CALORIES) AS stddev_val,
        MAX(CALORIES) AS max_val,
        COUNT(CALORIES) AS count_n,
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
), sleep_stats AS (
    SELECT
        AVG(TOTALMINUTESASLEEP)/60 AS mean_val,
        STDDEV(TOTALMINUTESASLEEP)/60 AS stddev_val,
        MAX(TOTALMINUTESASLEEP)/60 AS max_val,
        COUNT(TOTALMINUTESASLEEP) AS count_n,
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_SLEEP_RAW
), buckets AS (
    SELECT SEQ4() AS n
    FROM TABLE(GENERATOR(ROWCOUNT => 100))
), step_data AS (
    SELECT
        FLOOR(TOTALSTEPS / 2000) * 2000 AS bucket,
        COUNT(*) AS num_days
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
    GROUP BY bucket
), cal_data AS (
    SELECT
        FLOOR(CALORIES / 200) * 200 AS bucket,
        COUNT(*) AS num_days
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
    GROUP BY bucket
), sleep_data AS (
    SELECT
        FLOOR((TOTALMINUTESASLEEP/60) / 0.5) * 0.5 AS bucket,
        COUNT(*) AS num_days
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_SLEEP_RAW
    GROUP BY bucket
)
-- Steps Section
SELECT
    'Steps' AS metric_type,
    b.n * 2000 as bucket_start,
    CONCAT(b.n * 2000, ' - ', b.n * 2000 + 1999) AS data_range,
    COALESCE(d.num_days, 0) AS num_days,
    ROUND(s.mean_val, 0) AS mean_val,
    ROUND(s.stddev_val, 0) AS stddev_val,    
    ROUND(s.mean_val - s.stddev_val, 0) AS minus_1_std,
    ROUND(s.mean_val + s.stddev_val, 0) AS plus_1_std
FROM buckets b
LEFT JOIN step_data d 
    ON b.n * 2000 = d.bucket
CROSS JOIN step_stats s
WHERE b.n * 2000 <= s.max_val

UNION ALL

-- Calories Section
SELECT
    'Calories' AS metric_type,
    b.n * 200 as bucket_start,
    CONCAT(b.n * 200, ' - ', b.n * 200 + 199) AS data_range,
    COALESCE(d.num_days, 0) AS num_days,
    ROUND(s.mean_val, 0) AS mean_val,
    ROUND(s.stddev_val, 0) AS stddev_val,  
    ROUND(s.mean_val - s.stddev_val, 0) AS minus_1_std,
    ROUND(s.mean_val + s.stddev_val, 0) AS plus_1_std
FROM buckets b
LEFT JOIN cal_data d 
    ON b.n * 200 = d.bucket
CROSS JOIN cal_stats s
WHERE b.n * 200 <= s.max_val

UNION ALL

-- Sleep Section
SELECT
    'Sleep' AS metric_type,
    b.n * 0.5 as bucket_start,
    CONCAT(b.n * 0.5, ' - ', b.n * 0.5 + 0.49) AS data_range,
    COALESCE(d.num_days, 0) AS num_days,
    ROUND(s.mean_val, 0) AS mean_val,
    ROUND(s.stddev_val, 0) AS stddev_val,  
    ROUND(s.mean_val - s.stddev_val, 0) AS minus_1_std,
    ROUND(s.mean_val + s.stddev_val, 0) AS plus_1_std
FROM buckets b
LEFT JOIN sleep_data d 
    ON b.n * 0.5 = d.bucket
CROSS JOIN sleep_stats s
WHERE b.n * 0.5 <= s.max_val;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.HISTOGRAM_DISTS;

-- =============================================================================
-- 3. FitBit Steps, Calories, and Sleep Time Series
-- Purpose: Create time series view of daily health markers for Looker Studio dashboard
--      This will be our main table in Looker so will add extra analysis in here
-- SQL Logic: Outer Join disparate ID & date columns into a single CALENDAR_DATE, and
--      combine all avaliable data for each given date. Also calculate simple metrics like
--      Hard Work % and Sleep Efficency Score
--      Also include more complex modeling for the Global Mean, Standard Deviation, And Z-Scores
--      for each user's Steps, Calories, and 
--      Also calculate rolling 7 day averages for the same metrics using Window Functions=
--      Calculate if today's effort / steps / sleep was different than the last 7 days
-- Goal: Demonstrate ability to use Window Functions and CTEs and finalize a table that is
--      Looker Studio ready for visualizations
-- =============================================================================

CREATE OR REPLACE VIEW ANALYSIS_VIEWS.DAILY_USER_PERFORMANCE AS
WITH base_metrics AS (
    SELECT
        COALESCE(s.ID, a.ID) AS USER_ID,
        -- join with THAT NIGHT's sleep
        COALESCE(a.ACTIVITYDATE, DATEADD('day', -1, s.CORRECT_DATE)) AS CALENDAR_DATE,
        DAYOFWEEK(COALESCE(a.ACTIVITYDATE, DATEADD('day', -1, s.CORRECT_DATE))) AS WEEKDAY_NUMBER,
        DAYNAME(COALESCE(a.ACTIVITYDATE, DATEADD('day', -1, s.CORRECT_DATE))) AS WEEKDAY_NAME,
        
        -- Sleep Data and Calcs
        s.TOTALMINUTESASLEEP,
        s.TOTALMINUTESASLEEP/60 AS TOTALHOURSASLEEP,
        s.TOTALTIMEINBED,
        (s.TOTALTIMEINBED - s.TOTALMINUTESASLEEP) AS TOTALMINUTESAWAKE,
        ROUND((s.TOTALMINUTESASLEEP / NULLIF(s.TOTALTIMEINBED, 0)) * 100, 1) AS SLEEP_EFFICIENCY_PCT,
    
        -- Calories
        a.CALORIES,
    
        -- Steps and Effort Data
        a.TOTALSTEPS,
        a.VERYACTIVEMINUTES,
        a.FAIRLYACTIVEMINUTES,
        a.LIGHTLYACTIVEMINUTES,
    
        -- Hard Work Pct
        ZEROIFNULL(a.VERYACTIVEMINUTES / NULLIF(a.VERYACTIVEMINUTES + a.FAIRLYACTIVEMINUTES +
            a.LIGHTLYACTIVEMINUTES, 0)
    	) * 100 AS HARD_WORK_PCT,
    
        -- Goals
        8 AS SLEEP_GOAL_HOURS,
        7000 AS DAILY_STEP_GOAL,
        95 AS SLEEP_EFF_GOAL,
        10 AS HARD_WORK_EFF_GOAL,
        1000 AS CAL_GOAL
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_SLEEP_RAW s
    FULL OUTER JOIN WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW a
        -- join with THAT NIGHT's sleep
        ON s.ID = a.ID AND s.CORRECT_DATE = DATEADD('day', 1, a.ACTIVITYDATE)
    WHERE COALESCE(a.ACTIVITYDATE, DATEADD('day', -1, s.CORRECT_DATE)) IS NOT NULL
),
goal_diffs_rolling_stats AS (
    SELECT
        *,

        -- Goal Differneitals as a Percentages
        ROUND((TOTALHOURSASLEEP - SLEEP_GOAL_HOURS) / SLEEP_GOAL_HOURS * 100, 1) AS SLEEP_GOAL_DIFF_PCT,
        ROUND((TOTALSTEPS - DAILY_STEP_GOAL) / DAILY_STEP_GOAL * 100, 1) AS STEP_GOAL_DIFF_PCT,  
        (SLEEP_EFFICIENCY_PCT - SLEEP_EFF_GOAL) AS SLEEP_EFF_GOAL_PCT_DIFF,
        (HARD_WORK_PCT - HARD_WORK_EFF_GOAL) AS HARD_WORK_GOAL_PCT_DIFF,
        (CALORIES - CAL_GOAL) AS CAL_GOAL_DIFF,

    	-- 7-Day Rolling Averages
        AVG(TOTALHOURSASLEEP) OVER (
            PARTITION BY USER_ID ORDER BY CALENDAR_DATE
            RANGE BETWEEN INTERVAL '6 days' PRECEDING AND CURRENT ROW
        ) AS SLEEP_7DAY_ROLLING_AVG,
        AVG(TOTALSTEPS) OVER (
            PARTITION BY USER_ID ORDER BY CALENDAR_DATE
            RANGE BETWEEN INTERVAL '6 days' PRECEDING AND CURRENT ROW
        ) AS STEPS_7DAY_ROLLING_AVG,
        AVG(CALORIES) OVER (
            PARTITION BY USER_ID ORDER BY CALENDAR_DATE
            RANGE BETWEEN INTERVAL '6 days' PRECEDING AND CURRENT ROW
        ) AS CALORIES_7DAY_ROLLING_AVG,
    
        -- 7-Day Rolling Standard Deviations
        STDDEV(TOTALHOURSASLEEP) OVER (
            PARTITION BY USER_ID ORDER BY CALENDAR_DATE
            RANGE BETWEEN INTERVAL '6 days' PRECEDING AND CURRENT ROW
        ) AS SLEEP_7DAY_ROLLING_STDDEV,
        STDDEV(TOTALSTEPS) OVER (
            PARTITION BY USER_ID ORDER BY CALENDAR_DATE
            RANGE BETWEEN INTERVAL '6 days' PRECEDING AND CURRENT ROW
        ) AS STEPS_7DAY_ROLLING_STDDEV,
        STDDEV(CALORIES) OVER (
            PARTITION BY USER_ID ORDER BY CALENDAR_DATE
            RANGE BETWEEN INTERVAL '6 days' PRECEDING AND CURRENT ROW
        ) AS CALORIES_7DAY_ROLLING_STDDEV,
    
        -- Regression R^2 Value between Sleep and Steps/Very Active Minutes by User ID
        -- Population-level R^2 
        REGR_R2(TOTALMINUTESASLEEP, TOTALSTEPS) OVER () AS STEPS_SLEEP_RSQUARED_TOTAL,
        REGR_R2(TOTALMINUTESASLEEP, VERYACTIVEMINUTES) OVER () AS ACTIVE_SLEEP_RSQUARED_TOTAL,
        REGR_R2(TOTALSTEPS, VERYACTIVEMINUTES) OVER () AS STEPS_ACTIVE_RSQUARED_TOTAL,
        -- Will place a regression line via Looker Studio
        REGR_R2(TOTALMINUTESASLEEP, TOTALSTEPS) OVER (PARTITION BY USER_ID) AS STEPS_SLEEP_RSQUARED_USER,
        REGR_R2(TOTALMINUTESASLEEP, VERYACTIVEMINUTES) OVER (PARTITION BY USER_ID) AS ACTIVE_SLEEP_RSQUARED_USER,
        REGR_R2(TOTALSTEPS, VERYACTIVEMINUTES) OVER (PARTITION BY USER_ID) AS STEPS_ACTIVE_RSQUARED_USER



    FROM base_metrics
)
SELECT
    *,  
    -- Z-Scores: how does today compare to the rolling 7-day window?
    (TOTALSTEPS - STEPS_7DAY_ROLLING_AVG) / NULLIF(STEPS_7DAY_ROLLING_STDDEV, 0) AS STEPS_ZSCORE,
    (TOTALHOURSASLEEP - SLEEP_7DAY_ROLLING_AVG) / NULLIF(SLEEP_7DAY_ROLLING_STDDEV, 0) AS SLEEP_ZSCORE,
    (CALORIES - CALORIES_7DAY_ROLLING_AVG) / NULLIF(CALORIES_7DAY_ROLLING_STDDEV, 0) AS CALORIES_ZSCORE
FROM goal_diffs_rolling_stats
ORDER BY CALENDAR_DATE DESC, USER_ID;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.DAILY_USER_PERFORMANCE;

-- =================================
-- 3a. FitBit Activity Breakdown Pie Chart 
-- Create a singular view for the Activity Breakdown Pie Charts on the Dashboard Page
CREATE OR REPLACE VIEW ANALYSIS_VIEWS.ACTIVITY_BREAKDOWN AS                                      
SELECT 
    ID,
    ACTIVITYDATE,
    'Very Active' AS ACTIVITY_TYPE,
    VERYACTIVEMINUTES AS MINUTES,
    22 as RECOMMENDED_MINUTES
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
WHERE VERYACTIVEMINUTES IS NOT NULL
UNION ALL
SELECT 
    ID,
    ACTIVITYDATE,
    'Fairly Active' AS ACTIVITY_TYPE,
    FAIRLYACTIVEMINUTES AS MINUTES,
    NULL
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
WHERE FAIRLYACTIVEMINUTES IS NOT NULL
UNION ALL
SELECT 
    ID,
    ACTIVITYDATE,
    'Lightly Active' AS ACTIVITY_TYPE,
    LIGHTLYACTIVEMINUTES AS MINUTES,
    NULL
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
WHERE LIGHTLYACTIVEMINUTES IS NOT NULL
UNION ALL
SELECT 
    ID,
    ACTIVITYDATE,
    'Sedentary' AS ACTIVITY_TYPE,
    SEDENTARYMINUTES AS MINUTES,
    NULL
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW
WHERE SEDENTARYMINUTES IS NOT NULL;

-- =================================
-- 3b. FitBit Sleep Breakdown Pie Chart 
-- Create a singular view for the Sleep Breakdown Pie Charts on the Dashboard Page
CREATE OR REPLACE VIEW ANALYSIS_VIEWS.SLEEP_BREAKDOWN AS
SELECT 
    USER_ID,
    CALENDAR_DATE,
    'Asleep' AS SLEEP_TYPE,
    TOTALMINUTESASLEEP AS MINUTES
FROM ANALYSIS_VIEWS.DAILY_USER_PERFORMANCE
WHERE TOTALMINUTESASLEEP IS NOT NULL
UNION ALL
SELECT
    USER_ID,
    CALENDAR_DATE,
    'Awake in Bed' AS SLEEP_TYPE,
    TOTALMINUTESAWAKE AS MINUTES
FROM ANALYSIS_VIEWS.DAILY_USER_PERFORMANCE
WHERE TOTALMINUTESAWAKE IS NOT NULL;

-- =================================
-- 3c. FitBit Segmentation by Step Count 
-- Create a singular view for the Sleep Breakdown Pie Charts on the Dashboard Page
CREATE OR REPLACE VIEW WHOOP_HEALTH_DB.ANALYSIS_VIEWS.STEPS_SLEEP_TRADEOFF AS
SELECT
    CASE
        WHEN a.TOTALSTEPS >= 10000 THEN 'High (10K+ steps)'
        WHEN a.TOTALSTEPS >= 5000 THEN 'Medium (5K-10K)'
        WHEN a.TOTALSTEPS > 0 THEN 'Low (<5K steps)'
        ELSE 'No steps'
    END AS activity_level,
    CASE
        WHEN a.TOTALSTEPS >= 10000 THEN 3
        WHEN a.TOTALSTEPS >= 5000 THEN 2
        WHEN a.TOTALSTEPS > 0 THEN 1
        ELSE 0
    END AS sort_column,
    COUNT(*) AS num_days,
    ROUND(AVG(a.TOTALSTEPS), 0) AS avg_steps,
    ROUND(AVG(a.CALORIES), 0) AS avg_calories,
    ROUND(AVG(s.TOTALMINUTESASLEEP) / 60, 1) AS avg_sleep_hrs,
    ROUND(AVG(a.VERYACTIVEMINUTES), 0) AS avg_very_active_mins,
    ROUND(AVG(a.FAIRLYACTIVEMINUTES), 0) AS avg_fairly_active_mins,
    ROUND(AVG(a.LIGHTLYACTIVEMINUTES), 0) AS avg_lightly_active_mins,
    ROUND(AVG(a.SEDENTARYMINUTES), 0) AS avg_sedentary
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW a
JOIN WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_SLEEP_RAW s
    ON a.ID = s.ID
    -- join with THAT NIGHT's sleep
    AND s.CORRECT_DATE = DATEADD('day', 1, a.ACTIVITYDATE)
GROUP BY activity_level, sort_column;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.STEPS_SLEEP_TRADEOFF;

-- =================================
-- 3d. FitBit Segmentation by Active Time 
-- Create a singular view for the Sleep Breakdown Pie Charts on the Dashboard Page
CREATE OR REPLACE VIEW WHOOP_HEALTH_DB.ANALYSIS_VIEWS.ACTIVE_SLEEP_TRADEOFF AS
SELECT
    CASE
        WHEN a.VERYACTIVEMINUTES >= 75 THEN 'High (>75min)'
        WHEN a.VERYACTIVEMINUTES >= 15 THEN 'Medium (15 - 75min)'
        WHEN a.VERYACTIVEMINUTES > 0 THEN 'Low (<15min)'
        ELSE 'No activity'
    END AS activity_level,
    CASE
        WHEN a.VERYACTIVEMINUTES >= 75 THEN 3
        WHEN a.VERYACTIVEMINUTES >= 15 THEN 2
        WHEN a.VERYACTIVEMINUTES > 0 THEN 1
        ELSE 0
    END AS sort_column,
    COUNT(*) AS num_days,
    ROUND(AVG(a.TOTALSTEPS), 0) AS avg_steps,
    ROUND(AVG(a.CALORIES), 0) AS avg_calories,
    ROUND(AVG(s.TOTALMINUTESASLEEP) / 60, 1) AS avg_sleep_hrs,
    ROUND(AVG(a.VERYACTIVEMINUTES), 0) AS avg_very_active_mins,
    ROUND(AVG(a.FAIRLYACTIVEMINUTES), 0) AS avg_fairly_active_mins,
    ROUND(AVG(a.LIGHTLYACTIVEMINUTES), 0) AS avg_lightly_active_mins,
    ROUND(AVG(a.SEDENTARYMINUTES), 0) AS avg_sedentary
FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_ACTIVITY_RAW a
JOIN WHOOP_HEALTH_DB.RAW_HEALTH_DATA.FITBIT_SLEEP_RAW s
    ON a.ID = s.ID
    -- join with THAT NIGHT's sleep
    AND s.CORRECT_DATE = DATEADD('day', 1, a.ACTIVITYDATE)
GROUP BY activity_level, sort_column;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.ACTIVE_SLEEP_TRADEOFF;


    
-- =============================================================================
-- 4. Weekday View of Steps, Calories, & Sleep
-- Purpose: Calculate Weekday avg baseline metrics for all FitBit users and store in
--      a reference View to see if effort varies by weekday
-- Goal: Demonstrate ability to use Window Functions
-- =============================================================================

CREATE OR REPLACE VIEW ANALYSIS_VIEWS.USER_WEEKLY_DASHBOARD AS
WITH DAY_OF_WEEK_STATS AS (
    SELECT
        USER_ID,
        DAYOFWEEK(CALENDAR_DATE) as DOW,
        AVG(TOTALSTEPS) as AVG_STEPS,
        AVG(CALORIES) as AVG_CALORIES,
        AVG(TOTALMINUTESASLEEP)/60 as AVG_SLEEP
    FROM ANALYSIS_VIEWS.DAILY_USER_PERFORMANCE
    GROUP BY USER_ID, DOW
)
-- Steps
SELECT
    USER_ID,
    'STEPS' AS METRIC_TYPE,
    MAX(CASE WHEN DOW = 1 THEN AVG_STEPS END) AS MON,
    MAX(CASE WHEN DOW = 2 THEN AVG_STEPS END) AS TUE,
    MAX(CASE WHEN DOW = 3 THEN AVG_STEPS END) AS WED,
    MAX(CASE WHEN DOW = 4 THEN AVG_STEPS END) AS THU,
    MAX(CASE WHEN DOW = 5 THEN AVG_STEPS END) AS FRI,
    MAX(CASE WHEN DOW = 6 THEN AVG_STEPS END) AS SAT,
    MAX(CASE WHEN DOW = 0 THEN AVG_STEPS END) AS SUN
FROM DAY_OF_WEEK_STATS
GROUP BY USER_ID, METRIC_TYPE

UNION ALL -- make 2nd row for each USER

-- Calories
SELECT
    USER_ID,
    'CALORIES' AS METRIC_TYPE,
    MAX(CASE WHEN DOW = 1 THEN AVG_CALORIES END) AS MON,
    MAX(CASE WHEN DOW = 2 THEN AVG_CALORIES END) AS TUE,
    MAX(CASE WHEN DOW = 3 THEN AVG_CALORIES END) AS WED,
    MAX(CASE WHEN DOW = 4 THEN AVG_CALORIES END) AS THU,
    MAX(CASE WHEN DOW = 5 THEN AVG_CALORIES END) AS FRI,
    MAX(CASE WHEN DOW = 6 THEN AVG_CALORIES END) AS SAT,
    MAX(CASE WHEN DOW = 0 THEN AVG_CALORIES END) AS SUN
FROM DAY_OF_WEEK_STATS
GROUP BY USER_ID, METRIC_TYPE

UNION ALL -- make 3rd row for each USER

-- Sleep
SELECT
    USER_ID,
    'SLEEP_HOURS' AS METRIC_TYPE,
    MAX(CASE WHEN DOW = 1 THEN AVG_SLEEP END) AS MON,
    MAX(CASE WHEN DOW = 2 THEN AVG_SLEEP END) AS TUE,
    MAX(CASE WHEN DOW = 3 THEN AVG_SLEEP END) AS WED,
    MAX(CASE WHEN DOW = 4 THEN AVG_SLEEP END) AS THU,
    MAX(CASE WHEN DOW = 5 THEN AVG_SLEEP END) AS FRI,
    MAX(CASE WHEN DOW = 6 THEN AVG_SLEEP END) AS SAT,
    MAX(CASE WHEN DOW = 0 THEN AVG_SLEEP END) AS SUN
FROM DAY_OF_WEEK_STATS
GROUP BY USER_ID, METRIC_TYPE;
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.USER_WEEKLY_DASHBOARD;


-- =============================================================================
-- 5. Health Blood Markers: for Advanced Labs-like data
-- Purpose: Advanced Querying and calculate Z-scores to show when a blood marker
--      is out of a normal range (would be used in Advanced Labs)
--      Currently assuming the data represents a random selection of healthy adults
--      [Already flawed because this is ICU data, and also blood markers "range" 
--      wouldn't follow a normal distribution necessarily]
-- Goal: Use CTE to create mean and standard deviation, then calculate Z-score in 
--      new View
-- =============================================================================

CREATE OR REPLACE VIEW ANALYSIS_VIEWS.MIMIC_CLINICAL_INSIGHTS AS                                 
-- Get each subject's most recent date PER BIOMARKER      
WITH Recent_Window AS (                                                                       
    SELECT
        *,
        MAX(TO_DATE(CHARTTIME, 'YYYY/MM/DD')) OVER (PARTITION BY SUBJECT_ID, ITEMID) AS LATEST_DATE
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.MIMIC_LAB_EVENTS_RAW
    WHERE ITEMID IN (50931, 51222, 51265, 51282, 50983) -- BioMarkers included belwo
      AND VALUENUM IS NOT NULL
),
Statistics_Calc AS (
    -- Calculate stats for each ItemID across ALL time (full history)
    SELECT
        ITEMID,
        AVG(VALUENUM) as global_avg,
        STDDEV(VALUENUM) as global_stddev
    FROM WHOOP_HEALTH_DB.RAW_HEALTH_DATA.MIMIC_LAB_EVENTS_RAW
    GROUP BY ITEMID
)
SELECT
    l.SUBJECT_ID,
    TO_DATE(l.CHARTTIME, 'YYYY/MM/DD') AS DATE,
    l.LATEST_DATE,
    l.ITEMID,
    d.LABEL as Bio_Marker,
    l.VALUENUM,
    -- Calculate Z-Score (against full history benchmarks)
    (l.VALUENUM - s.global_avg) / NULLIF(s.global_stddev, 0) AS z_score,

    CASE
        WHEN (l.VALUENUM - s.global_avg) / NULLIF(s.global_stddev, 0) > 1 THEN 'Above Normal'    
        WHEN (l.VALUENUM - s.global_avg) / NULLIF(s.global_stddev, 0) < -1 THEN 'Below Normal'   
        ELSE 'Optimal Range'
    END AS PERFORMANCE_RANGE,

    (global_avg + global_stddev) AS NORMAL_HIGH,
    (global_avg - global_stddev) AS NORMAL_LOW

FROM Recent_Window l
JOIN Statistics_Calc s ON l.ITEMID = s.ITEMID
LEFT JOIN WHOOP_HEALTH_DB.RAW_HEALTH_DATA.MIMIC_LAB_ITEMS_RAW d ON l.ITEMID = d.ITEMID
WHERE TO_DATE(l.CHARTTIME, 'YYYY/MM/DD') >= DATEADD('day', -30, l.LATEST_DATE); 
SELECT * FROM WHOOP_HEALTH_DB.ANALYSIS_VIEWS.MIMIC_CLINICAL_INSIGHTS;


-- BIO MARKERS Item ID
    -- GLUCOSE == 50931
    -- HEMOGLOBIN == 51222
    -- PLATELET COUNT == 51265
    -- RETICULOCYTE COUNT == 51282
    -- SODIUM == 50983





